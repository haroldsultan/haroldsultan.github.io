<!DOCTYPE html>
<html>
<head>
    <title>SEV Saturation Visualizer</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin-top: 20px;
        }
        .sev-entry {
            margin-bottom: 20px;
        }
        .key {
            margin-top: 20px;
        }
        .key div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .key span {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>SEV Saturation Visualizer</h1>
    <div class="sev-entry">
        <label for="sev-level">Severity Level:</label>
        <select id="sev-level">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
        </select><br>
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date"><br>
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date"><br>
        <button onclick="addSEV()">Add SEV</button>
    </div>
    <div class="date-range">
        <label for="graph-start-date">Graph Start Date:</label>
        <input type="date" id="graph-start-date"><br>
        <label for="graph-end-date">Graph End Date:</label>
        <input type="date" id="graph-end-date"><br>
        <button onclick="drawHeatmap()">Update Graph</button>
    </div>
    <canvas id="heatmap" width="1000" height="500"></canvas>
    <div class="csv-upload">
        <label for="csv-file">Upload CSV:</label>
        <input type="file" id="csv-file" accept=".csv"><br>
        <button onclick="uploadCSV()">Upload</button>
    </div>
    <div class="csv-download">
        <button onclick="downloadCSV()">Download Current SEVs as CSV</button>
    </div>
    <div class="key">
        <h3>Severity Key:</h3>
        <div><span style="background-color: rgba(255, 0, 0, 0.5);"></span>Severity 0</div>
        <div><span style="background-color: rgba(255, 165, 0, 0.5);"></span>Severity 1</div>
        <div><span style="background-color: rgba(255, 255, 0, 0.5);"></span>Severity 2</div>
        <div><span style="background-color: rgba(0, 255, 0, 0.5);"></span>Severity 3</div>
        <div><span style="background-color: rgba(0, 0, 255, 0.5);"></span>Severity 4</div>
    </div>
    <script>
        const SEVs = [];
        const canvas = document.getElementById('heatmap');
        const ctx = canvas.getContext('2d');
        const severityHeights = [1, 0.8, 0.6, 0.4, 0.2]; // Heights for SEV 0 to SEV 4

        function addSEV() {
            const level = document.getElementById('sev-level').value;
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);

            if (startDate >= endDate) {
                alert("Start date must be before end date");
                return;
            }

            SEVs.push({ level, startDate, endDate });
            drawHeatmap();
        }

        function drawHeatmap() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let startTime, endTime;

            const graphStartDateInput = document.getElementById('graph-start-date').value;
            const graphEndDateInput = document.getElementById('graph-end-date').value;

            if (graphStartDateInput && graphEndDateInput) {
                startTime = new Date(graphStartDateInput);
                endTime = new Date(graphEndDateInput);
            } else {
                const now = new Date();
                startTime = new Date(now - 90 * 24 * 60 * 60 * 1000);
                endTime = now;
            }

            const timeSpan = endTime - startTime;

            // Initialize a buffer for each pixel on the x-axis to keep track of combined severity levels
            const buffer = Array(canvas.width).fill(0);

            SEVs.forEach(sev => {
                const xStart = Math.floor(((sev.startDate - startTime) / timeSpan) * canvas.width);
                const xEnd = Math.ceil(((sev.endDate - startTime) / timeSpan) * canvas.width);
                const severityLevel = parseInt(sev.level);

                for (let x = xStart; x < xEnd; x++) {
                    if (x >= 0 && x < canvas.width) {
                        buffer[x] += severityHeights[severityLevel];
                    }
                }
            });

            // Draw the buffer on the canvas
            for (let x = 0; x < canvas.width; x++) {
                const height = buffer[x] * canvas.height;
                const color = getColorByCombinedSeverity(buffer[x]);
                ctx.fillStyle = color;
                ctx.fillRect(x, canvas.height - height, 1, height);
            }

            drawXAxis(startTime, endTime);
        }

        function drawXAxis(startTime, endTime) {
            ctx.fillStyle = "black";
            ctx.font = "12px Arial";
            const timeSpan = endTime - startTime;
            const numDivisions = 10;
            for (let i = 0; i <= numDivisions; i++) {
                const x = (i / numDivisions) * canvas.width;
                const date = new Date(startTime.getTime() + (i / numDivisions) * timeSpan);
                const dateStr = date.toISOString().split('T')[0];
                ctx.fillText(dateStr, x, canvas.height - 10);
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - 20);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
        }

        function getColorByCombinedSeverity(combinedSeverity) {
            if (combinedSeverity >= 1) return 'rgba(255, 0, 0, 0.5)'; // Red
            if (combinedSeverity >= 0.8) return 'rgba(255, 165, 0, 0.5)'; // Orange
            if (combinedSeverity >= 0.6) return 'rgba(255, 255, 0, 0.5)'; // Yellow
            if (combinedSeverity >= 0.4) return 'rgba(0, 255, 0, 0.5)'; // Green
            if (combinedSeverity >= 0.2) return 'rgba(0, 0, 255, 0.5)'; // Blue
            return 'rgba(0, 0, 0, 0.5)'; // Black
        }

        function uploadCSV() {
          const fileInput = document.getElementById('csv-file');
          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = function(e) {
              const text = e.target.result;
              const lines = text.split('\n');
              const header = lines[0].split(',');
              if (header[0].trim() !== 'sev_start' || header[1].trim() !== 'sev_end' || header[2].trim() !== 'severity') {
                  alert('Invalid CSV format');
                  return;
              }
              for (let i = 1; i < lines.length; i++) {
                  const line = lines[i].trim();
                  if (line) {
                      const [sev_start, sev_end, severity] = line.split(',');
                      SEVs.push({
                          level: severity.trim(),
                          startDate: new Date(sev_start.trim()),
                          endDate: new Date(sev_end.trim())
                      });
                  }
              }
              drawHeatmap();
          };
          reader.readAsText(file);
        }

        function downloadCSV() {
          const csvContent = 'sev_start,sev_end,severity\n' +
              SEVs.map(sev => `${sev.startDate.toISOString().split('T')[0]},${sev.endDate.toISOString().split('T')[0]},${sev.level}`).join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'sev_data.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
      }

        window.onload = function() {
            const now = new Date();
            document.getElementById('graph-start-date').value = new Date(now - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('graph-end-date').value = now.toISOString().split('T')[0];
            drawHeatmap();
        }
    </script>
</body>
</html>
